'use strict';

var _ = require('lodash');

var BuildError = require('chiton/core/errors/build-error');
var BuildStatsPlugin = require('chiton/config/webpack/plugins/build-stats');
var ConfigurationError = require('chiton/core/errors/configuration-error');

/**
 * Load statistics on a webpack build
 *
 * @param {object} config A valid webpack configuration
 * @returns {ChitonBuildStats} Details on the build
 * @throws {ConfigurationError} If build statistics are not generated by the configuration
 * @throws {BuildError} If the build statistics cannot be loaded
 */
function loadStats(config) {
  var plugins = config.plugins || [];
  var statsPlugin = _.find(plugins, plugin => plugin.constructor === BuildStatsPlugin);

  if (!statsPlugin) {
    throw new ConfigurationError('The configuration does not use the build-stats plugin');
  }

  try {
    return statsPlugin.loadStats();
  } catch (e) {
    throw new BuildError('The build statistics could not be loaded');
  }
}

module.exports = {
  loadStats: loadStats
};
